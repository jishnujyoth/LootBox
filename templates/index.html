<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottie Library</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.9.4/lottie.min.js"></script>
    <script>
        // Make lottie available globally for our SVG export feature
        window.lottie = window.bodymovin || window.lottie;
    </script>
    <style>
        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f4ff 0%, #fff1f1 100%);
            color: #202124;
            min-height: 100vh;
            /* Set perspective for 3D cube */
            perspective: 800px;
            --S: 100px; /* Size of the cube faces (increased by 25%) */
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 40px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
        }
        :root {
            --primary-color: #4c7bff;
            --bg-gradient: radial-gradient(circle at center, #ffffff 0%, #f0f4ff 100%);
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --search-bg: #ffffff;
            --search-shadow: 0 2px 6px rgba(76, 123, 255, 0.25);
            --search-focus-shadow: 0 4px 12px rgba(76, 123, 255, 0.2);
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            background: var(--bg-gradient);
        }
        
        /* Class to prevent background scrolling when modals are open */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
            color: #202124;
            min-height: 100vh;
        }
        
        /* Main content container completely separate from header */
        #mainContent {
            padding-top: 70px; /* Extra padding to ensure content is below header */
            width: 100%;
            position: relative;
            z-index: 1;
            isolation: isolate; /* Create separate stacking context */
            overflow-x: hidden; /* Prevent horizontal overflow */
        }

        /* Simple header styles */
        #header {
            padding: 8px 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 48px;
        }

        #header-wrapper.hidden {
            /* Only hidden when explicitly set */
            display: none;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .controls-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .size-controls {
            display: flex;
            align-items: center;
            background: var(--search-bg);
            border-radius: 20px;
            padding: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            width: fit-content;
            overflow: hidden;
            margin-right: 8px;
            transition: all 0.3s var(--transition-timing);
        }
        
        .size-controls:not(:hover) .size-btn:not(.active) {
            width: 0;
            padding: 0;
            margin: 0;
            opacity: 0;
            pointer-events: none;
        }
        
        .size-btn {
            border: none;
            background: transparent;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 16px;
            cursor: pointer;
            color: #5f6368;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s var(--transition-timing);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .size-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
        }

        .site-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }

        .home-button {
            padding: 8px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--search-shadow);
            transition: all 0.3s var(--transition-timing);
        }

        .home-button:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--search-focus-shadow);
        }
        
        .admin-button {
            padding: 8px;
            width: 36px;
            height: 36px;
            background-color: #fff;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--search-shadow);
            transition: all 0.3s var(--transition-timing);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .admin-button:hover {
            background-color: #f8f9fa;
            box-shadow: var(--search-focus-shadow);
        }
        
        .admin-button.active {
            background-color: #202124;
            color: white;
        }
        
        /* Admin controls on animation cards */
        .admin-controls {
            position: absolute;
            top: 4px;
            left: 4px; /* Position on left instead of right */
            z-index: 10;
            display: flex;
            gap: 2px;
            padding: 0;
            margin: 0;
            transform: scale(0.75); /* Reduce size further */
            transform-origin: top left; /* Change origin to match new position */
            opacity: 0; /* Hide by default */
            transition: opacity 0.2s ease; /* Smooth transition when appearing */
        }
        
        /* Show admin controls on hover of parent */
        .animation-card:hover .admin-controls {
            opacity: 1;
        }
        
        .delete-animation-btn {
            width: 20px; /* Keep same icon container size */
            height: 20px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #dadce0;
            color: #d93025;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .delete-animation-btn:hover {
            opacity: 1;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* Common modal styles */
        .delete-confirm-modal,
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .delete-confirm-modal.active,
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        .delete-confirm-content {
            width: 90%;
            max-width: 420px;
            background-color: white;
            border-radius: 16px;
            padding: 28px 32px;
            box-shadow: var(--search-focus-shadow);
            transform: translateY(20px);
            transition: transform 0.3s var(--transition-timing);
        }
        
        .delete-confirm-modal.active .delete-confirm-content {
            transform: translateY(0);
        }
        
        .modal-content {
            width: 90%;
            max-width: 500px;
            background-color: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 16px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #5f6368;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .svg-preview-container {
            width: 100%;
            height: 300px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .svg-frame-preview {
            width: 80%;
            height: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .frame-selection {
            margin-bottom: 24px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }
        
        .frame-slider {
            flex-grow: 1;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 2px;
        }
        
        .frame-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
        }
        
        .frame-value {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Modal styles compatible with download-options */
        .modal-body .download-options {
            justify-content: center;
        }
        
        /* Fix text alignment in buttons */
        .download-options .export-btn {
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* 3D Cube Logo Styles */
        .cube-container {
            width: 100%;
            display: flex;
            justify-content: center;
            position: fixed; /* Fixed positioning relative to viewport */
            top: calc(35vh - 10px); /* Reduced top position of cube container */
            left: 0;
            right: 0;
            z-index: 1; /* Lower z-index to ensure it doesn't interfere with clickable elements */
            pointer-events: none; /* Let events pass through to elements below */
        }
        
        .cube {
            pointer-events: auto; /* Re-enable events just for the cube */
            transform-style: preserve-3d;
            width: var(--S);
            height: var(--S);
            position: relative;
            transition: transform 0.2s ease-out;
        }
        
        /* Cube styles moved above */
        
        /* Button styles consolidated with export-btn */
        
        /* Cancel button styles consolidated with export-btn */
        
        .delete-confirm-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            margin-top: 32px;
        }
        
        .delete-confirm-cancel {
            padding: 10px 20px;
            border: 1px solid #e0e0e0;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 24px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s var(--transition-timing);
        }
        
        .delete-confirm-cancel:hover {
            background-color: rgba(76, 123, 255, 0.05);
        }
        
        .delete-confirm-delete {
            padding: 10px 20px;
            background-color: #d93025;
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(217, 48, 37, 0.2);
            transition: all 0.2s var(--transition-timing);
        }
        
        .delete-confirm-delete:hover {
            background-color: #c62828;
            box-shadow: 0 4px 8px rgba(217, 48, 37, 0.3);
        }
        
        .admin-text, .close-icon {
            transition: opacity 0.3s var(--transition-timing), transform 0.3s var(--transition-timing);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .admin-text {
            opacity: 1;
            transform: translateY(0);
        }
        
        .close-icon {
            opacity: 0;
            transform: translateY(5px);
        }
        
        .admin-button.active:hover .admin-text {
            opacity: 0;
            transform: translateY(-5px);
        }
        
        .admin-button.active:hover .close-icon {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Controls container transition */
        .controls-container {
            display: flex;
            gap: 12px;
            transition: all 0.3s var(--transition-timing);
        }
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh; /* Use viewport height */
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--transition-timing);
            /* Remove flex display */
        }
        
        .login-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .login-modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--search-focus-shadow);
            /* Explicitly position in the middle of viewport */
            position: absolute;
            top: 40%; /* Position above center for better visibility */
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .login-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .login-modal-header h2 {
            font-size: 24px;
            font-weight: 500;
            color: var(--primary-color);
            margin: 0;
        }
        
        .login-form input {
            width: 100%;
            padding: 16px;
            margin-bottom: 16px;
            border: none;
            border-radius: 12px;
            background: var(--search-bg);
            box-shadow: var(--search-shadow);
        }
        
        .login-form input:focus {
            outline: none;
            box-shadow: var(--search-focus-shadow);
        }
        
        .login-form button {
            width: 100%;
            padding: 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Upload panel styles */
        .admin-panel {
            display: none;
        }
        
        .admin-panel.active {
            display: block;
        }
        
        .admin-controls {
            background: #f8f9fa;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .admin-controls h3 {
            margin-top: 0;
            color: #202124;
            font-size: 18px;
            margin-bottom: 16px;
        }
        
        .upload-form {
            display: grid;
            gap: 16px;
        }
        
        /* Upload Popup Styles */
        .upload-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--transition-timing);
        }
        
        .upload-popup.active {
            opacity: 1;
            visibility: visible;
        }
        
        .upload-popup-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--search-focus-shadow);
        }
        
        .upload-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .upload-popup-header h3 {
            font-size: 24px;
            font-weight: 500;
            color: var(--primary-color);
            margin: 0;
        }
        
        .upload-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .upload-form label {
            font-size: 14px;
            font-weight: 500;
            color: #5f6368;
        }
        
        .upload-form input {
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
        }
        
        .upload-form select {
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            background: white;
        }
        
        .upload-form .save-btn {
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            justify-self: start;
            width: 100%;
            margin-top: 16px;
        }
        
        .save-btn:hover {
            background-color: #0056b3;
        }
        
        /* File items styling */
        .upload-files-container {
            margin: 16px 0;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 8px;
            background-color: #f8f9fa;
            padding: 8px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 12px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .file-type-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--primary-color);
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-info-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .file-format-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 8px;
            text-transform: uppercase;
        }
        
        .format-json {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        .format-mp4 {
            background-color: #fce4ec;
            color: #c2185b;
        }
        
        .format-gif {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }
        
        .progress-container {
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .upload-complete .progress-bar {
            background-color: #4caf50;
        }
        
        .upload-error .progress-bar {
            background-color: #f44336;
        }
        
        .file-item.success {
            border-left: 3px solid #4caf50;
        }
        
        .file-item.error {
            border-left: 3px solid #f44336;
        }
        
        /* Upload area and preview styling */
        .upload-area {
            position: relative;
        }
        
        /* Preview container styling */
        .preview-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 160px;
            background-color: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            display: none; /* Hidden by default */
            flex-direction: column;
        }
        
        .preview-animation {
            width: 100%;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-animation lottie-player {
            width: 100%;
            height: 100%;
        }
        
        .preview-controls {
            padding: 8px;
            display: flex;
            justify-content: center;
            background-color: rgba(0,0,0,0.05);
        }
        
        .change-files-btn {
            padding: 4px 12px;
            font-size: 12px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .change-files-btn:hover {
            background-color: #f0f0f0;
        }
        
        /* Dropzone styles */
        .dropzone {
            border: 2px dashed #dadce0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background-color: #fafafa;
            transition: all 0.3s var(--transition-timing);
            cursor: pointer;
            position: relative;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dropzone:hover, .dropzone.dragover {
            border-color: var(--primary-color);
            background-color: rgba(76, 123, 255, 0.05);
        }
        
        .dropzone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        
        .file-icon {
            color: #5f6368;
            margin-bottom: 8px;
        }
        
        .drop-text {
            font-size: 14px;
            color: #5f6368;
            margin: 8px 0;
        }
        
        .browse-text {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
        }
        
        .file-info {
            font-size: 12px;
            color: #80868b;
            margin: 4px 0;
        }
        
        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .selected-file {
            display: none;
            background-color: rgba(76, 123, 255, 0.1);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            color: var(--primary-color);
            margin-top: 12px;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-file {
            background: none;
            border: none;
            color: #5f6368;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            line-height: 0;
        }
        
        .remove-file:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: #d93025;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-top: calc(35vh + 50px); /* Significantly reduced padding to minimize gap with cube */
            transition: padding-top 0.8s var(--transition-timing);
        }

        .container.active {
            padding-top: 120px;
        }
        
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sidebar-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .nav-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .nav-link {
            display: block;
            padding: 16px 24px;
            color: #5f6368;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
            border-radius: 0 24px 24px 0;
            margin: 4px 8px 4px 0;
        }
        
        .nav-link:hover {
            background-color: #f8f9fa;
            color: #202124;
        }
        
        .nav-link.active {
            background-color: #e8f0fe;
            color: #1a73e8;
            font-weight: 500;
        }
        
        .main-content {
            width: 100%;
            box-sizing: border-box;
        }
        
        .search-container {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 60px;
        }

        .categories {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin: 32px 0;
            position: relative; /* Create stacking context */
            z-index: 5; /* Ensure higher than potential overlays */
            pointer-events: auto; /* Explicitly enable pointer events */
        }

        .category-btn {
            padding: 8px 24px;
            border-radius: 20px;
            border: none;
            background: white;
            color: #5f6368;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: 0.2s var(--transition-timing);
            box-shadow: var(--search-shadow);
            position: relative; /* Ensure proper stacking context */
            z-index: 10; /* Ensure buttons are clickable, higher than the cube container */
            pointer-events: auto; /* Force pointer events to be enabled */
        }

        .category-btn:hover {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--search-focus-shadow);
        }

        .category-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--search-focus-shadow);
        }
        
        /* Upload tab specific styling */
        .category-btn.upload-tab {
            background-color: #fff;
            color: #5f6368;
            border: 1px solid #dadce0;
        }
        
        .category-btn.upload-tab:hover {
            background-color: #f8f9fa;
        }
        
        .category-btn.upload-tab.active {
            background-color: #202124;
            color: white;
            border: none;
        }
        
        .header-info h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }
        .search-form {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        .search-form {
            position: relative;
            width: 100%;
            max-width: 600px;
        }

        .search-input {
            width: 100%;
            padding: 16px 48px;
            border: none;
            border-radius: 32px;
            font-size: 16px;
            transition: all 0.3s var(--transition-timing);
            outline: none;
            background: var(--search-bg);
            color: #202124;
            box-shadow: 0 4px 12px rgba(76, 123, 255, 0.35);
            position: relative;
            z-index: 1;
        }
        
        /* Search input animations */
        .search-container {
            position: relative;
            overflow: hidden;
            filter: drop-shadow(0 6px 12px rgba(76, 123, 255, 0.15));
            margin-top: -10px; /* Adjusted margin for optimal spacing with cube */
        }
        
        .search-form {
            position: relative;
            overflow: hidden;
            border-radius: 32px;
            display: flex;
            align-items: center;
        }
        
        /* Cube face styles */
        .face {
            position: absolute;
            width: var(--S);
            height: var(--S);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0; /* Removed corner radius as requested */
            font-weight: bold;
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        .face.front { transform: translateZ(calc(var(--S) / 2)); }
        .face.back { transform: rotateY(180deg) translateZ(calc(var(--S) / 2)); }
        .face.left { transform: rotateY(-90deg) translateZ(calc(var(--S) / 2)); }
        .face.right { transform: rotateY(90deg) translateZ(calc(var(--S) / 2)); }
        .face.top { transform: rotateX(90deg) translateZ(calc(var(--S) / 2)); }
        .face.bottom { transform: rotateX(-90deg) translateZ(calc(var(--S) / 2)); }
        
        /* Gradient colors for cube faces */
        .face.front { background: linear-gradient(135deg, #4285f4, #c2d9ff); }
        .face.back { background: linear-gradient(135deg, #e8f0fe, #4285f4); }
        .face.left { background: linear-gradient(135deg, #a1c2fa, #ffffff); }
        .face.right { background: linear-gradient(135deg, #ffffff, #a1c2fa); }
        .face.top { background: linear-gradient(135deg, #c2d9ff, #e8f0fe); }
        .face.bottom { background: linear-gradient(135deg, #e8f0fe, #c2d9ff); }
        
        
        .search-form::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            width: 100%;
            height: 100%;
            transform: scale(1) translateZ(0);
            filter: blur(12px);
            background: linear-gradient(
                to left,
                #4c7bff,
                #5f8aff,
                #729aff,
                #85a9ff,
                #98b9ff,
                #85a9ff,
                #729aff,
                #5f8aff,
                #4c7bff
            );
            background-size: 200% 200%;
            animation: animateGlow 3s ease-in-out infinite;
            opacity: 0.5;
            border-radius: 32px;
            pointer-events: none;
        }
        
        @keyframes animateGlow {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #5f6368;
            z-index: 2;
            transition: color 0.3s var(--transition-timing);
        }
        
        .search-form:hover .search-icon,
        .search-input:focus ~ .search-icon {
            color: var(--primary-color);
        }
        
        .search-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, rgba(76, 123, 255, 0), rgba(76, 123, 255, 0.06) 50%, rgba(76, 123, 255, 0) 100%);
            z-index: 0;
            animation: lightSweep 5s infinite linear, breatheOpacity 5s infinite ease-in-out;
        }
        
        @keyframes lightSweep {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        @keyframes breatheOpacity {
            0%, 100% {
                opacity: 0.3;
            }
            50% {
                opacity: 0.7;
            }
        }

        .search-input:hover {
            box-shadow: var(--search-focus-shadow);
        }

        .search-input:focus {
            box-shadow: var(--search-focus-shadow);
        }
        
        /* Glowing stroke animation on hover */
        .search-form:hover::after,
        .search-form:focus-within::after {
            content: '';
            position: absolute;
            top: 0;
            left: -200%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, 
                rgba(76, 123, 255, 0) 0%, 
                rgba(76, 123, 255, 0.6) 50%, 
                rgba(76, 123, 255, 0) 100%);
            z-index: 1;
            animation: glowingSweep 3.5s infinite linear;
            pointer-events: none;
            border-radius: 32px;
        }
        
        @keyframes glowingSweep {
            0% {
                left: -200%;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                left: 100%;
                opacity: 0;
            }
        }

        .search-form::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234c7bff'%3E%3Cpath d='M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E") center / contain no-repeat;
            opacity: 0.7;
        }
        .search-btn {
            padding: 8px 24px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            letter-spacing: 0.25px;
        }
        .search-btn:hover {
            background-color: #1557b0;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
        }
        .clear-btn {
            padding: 8px 24px;
            background-color: #fff;
            color: #1a73e8;
            border: 1px solid #dadce0;
            border-radius: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
            letter-spacing: 0.25px;
        }
        .clear-btn:hover {
            background-color: #f8f9fa;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);
        }
        .header-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        .total-count {
            font-size: 16px;
            color: #666;
        }
        h1 {
            color: #333;
            margin: 0;
        }
        .sync-btn {
            display: inline-block;
            margin-top: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .sync-btn:hover {
            background-color: #45a049;
        }
        .grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 32px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(40px);
            transition: 0.6s var(--transition-timing);
            padding: 0 20px;
        }
        
        .grid.size-small {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 24px;
        }
        
        .grid.size-medium {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 32px;
        }
        
        .grid.size-large {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 40px;
        }

        .grid.active {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animation-wrapper {
            aspect-ratio: 1;
            position: relative;
            cursor: pointer;
        }
        .animation-card {
            background: var(--search-bg);
            border-radius: 16px;
            box-shadow: var(--search-shadow);
            overflow: hidden;
            transition: all 0.3s var(--transition-timing);
            transform: scale(1);
            cursor: pointer;
            margin: 0;
            height: 100%;
        }

        .animation-card:hover {
            transform: translateY(-0.2px);
            box-shadow: var(--search-focus-shadow);
        }

        .category-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            background-color: rgba(0,0,0,0.6);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            z-index: 1;
        }
        .animation-card:hover {
            box-shadow: 0 1px 3px 0 rgba(60,64,67,.3), 0 4px 8px 3px rgba(60,64,67,.15);
        }
        .preview-container {
            width: 100%;
            aspect-ratio: 1;
            background-color: var(--search-bg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
        }
        .preview-container lottie-player {
            width: 100%;
            height: 100%;
        }
        .preview-container .thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 0.3s;
        }
        .preview-container:hover .thumbnail {
            opacity: 0;
        }
        .animation-info {
            padding: 16px;
            background: var(--search-bg);
        }
        .animation-name {
            margin: 0;
            color: #202124;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .download-btn {
            display: inline-block;
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }
        .download-btn:hover {
            background-color: #45a049;
        }
        #message {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        
        /* Inline button for SVG copy fallback */
        .inline-btn {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .inline-btn:hover {
            background-color: #3367d6;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        .pagination a {
            display: inline-block;
            padding: 8px 12px;
            background-color: white;
            color: #333;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .pagination a:hover {
            background-color: #f0f0f0;
        }
        .pagination .current {
            background-color: #4CAF50;
            color: white;
        }

        .popup-header {
            padding: 12px 16px;
            background-color: white;
            color: #202124;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            border-bottom: 1px solid rgba(76, 123, 255, 0.1);
            height: 40px;
        }

        .popup-header h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 500;
            color: var(--primary-color);
            letter-spacing: -0.5px;
        }

        .popup-header .close-popup {
            color: #5f6368;
            font-size: 24px;
            padding: 0;
            border-radius: 50%;
            transition: all 0.3s var(--transition-timing);
            cursor: pointer;
            border: none;
            background: var(--search-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            box-shadow: var(--search-shadow);
        }

        .popup-header .close-popup:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--search-focus-shadow);
        }

        .animation-details {
            padding: 20px;
            background: white;
            border-left: 1px solid rgba(76, 123, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .detail-section {
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-section .animation-name {
            font-size: 24px;
            font-weight: 500;
            color: #202124;
            margin-bottom: 8px;
        }

        .detail-section h3 {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-section .animation-name {
            font-size: 16px;
            color: #202124;
            margin: 0;
            font-weight: 400;
        }

        .download-options {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
        }

        .download-options .export-btn {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            border-radius: 12px;
            background-color: var(--search-bg);
            color: var(--primary-color);
            border: none;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.3s var(--transition-timing);
            box-shadow: var(--search-shadow);
            cursor: pointer;
            min-width: 70px;
            height: 42px;
            line-height: 18px;
            vertical-align: middle;
        }
        
        .download-options .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--search-bg);
            color: #5f6368;
        }

        .download-options .export-btn:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--search-focus-shadow);
        }
        
        /* Share button styles */
        .share-options {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .share-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.2s ease;
        }
        
        .share-btn:hover {
            background-color: #3367d6;
        }
        
        .share-tooltip {
            position: absolute;
            left: 110%;
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transform: translateY(-50%);
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .share-tooltip.visible {
            opacity: 1;
        }
        
        .download-options .disabled {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: none;
            pointer-events: none;
        }
        
        .download-options .admin-upload {
            background-color: rgba(76, 123, 255, 0.05);
            border: 1px dashed var(--primary-color);
        }
        
        .download-options .admin-upload:hover {
            background-color: rgba(76, 123, 255, 0.15);
        }
        
        .upload-icon {
            font-size: 14px;
            background-color: transparent;
            color: var(--primary-color);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            vertical-align: top;
            font-weight: bold;
        }
        
        .download-options a.export-btn {
            display: inline-flex;
            text-decoration: none;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-sizing: border-box;
        }

        .hashtags-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            margin: 8px 0 12px;
            font-size: 14px;
            background: #fff;
            box-shadow: var(--search-shadow);
            transition: all 0.3s var(--transition-timing);
            box-sizing: border-box;
            display: block;
        }

        .hashtags-input:hover,
        .hashtags-input:focus {
            box-shadow: var(--search-focus-shadow);
            outline: none;
        }

        .hashtags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .hashtag {
            background-color: var(--search-bg);
            color: var(--primary-color);
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            box-shadow: var(--search-shadow);
            transition: all 0.3s var(--transition-timing);
            gap: 8px;
            border: none;
            margin: 0 8px 8px 0;
        }

        .hashtag button {
            padding: 0;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
        }

        .popup-content {
            height: calc(100vh - 40px);
            overflow-y: auto;
            overscroll-behavior: contain; /* Prevents scroll chaining */
            padding-bottom: 40px; /* Extra padding at the bottom for better scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .popup-preview {
            margin: 20px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
            width: calc(100% - 40px);
            overflow: hidden;
            background-color: #f0f0f0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            padding: 32px;
            box-sizing: border-box;
            position: relative;
        }
        
        .popup-preview.dark-mode {
            background-color: #202124;
        }
        
        .bg-toggle-wrap {
            position: absolute;
            top: 8px;
            right: 8px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            margin-left: 8px;
        }
        
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #1a73e8;
        }
        
        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        #popupPlayer {
            max-width: 85%;
            max-height: 85%;
            margin: auto;
            width: auto !important;
            height: auto !important;
            display: block;
            box-sizing: border-box;
        }
        
        .popup-preview lottie-player {
            /* Consistent sizing for all animations */
            aspect-ratio: 1 / 1;
            object-fit: contain;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 3px solid #f1f3f4;
            border-radius: 50%;
            border-top-color: #1a73e8;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { 
                transform: rotate(360deg);
            }
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 4px;
            vertical-align: middle;
        }

        #message {
            display: none;
            padding: 12px 24px;
            border-radius: 8px;
            background-color: #fce8e6;
            color: #c5221f;
            text-align: center;
            margin: 20px auto;
            max-width: 400px;
            animation: fadeIn 0.3s ease;
        }

        /* Sidebar styles */
        .sidebar-details {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
            overflow: hidden; /* Prevent content overflow during transition */
            backface-visibility: hidden; /* Prevents flickering on some browsers */
            will-change: transform; /* Optimizes performance for the transform property */
        }

        .sidebar-details.active {
            transform: translateX(-400px);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 999;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* Mouse-interactive 3D cube scripts */
        @keyframes spin {
            from { transform: rotateX(0deg) rotateY(0deg); }
            to { transform: rotateX(360deg) rotateY(360deg); }
        }
        
        .cube {
            animation: 15s linear infinite spin;
            animation-play-state: running;
        }
        
        /* Cube hover effect - faces move outward with smooth transition */
        .face {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* Smooth ease-in-ease-out with slight bounce */
        }
        
        .cube:hover .face.front { transform: translateZ(calc(var(--S) / 2 + 20px)); }
        .cube:hover .face.back { transform: rotateY(180deg) translateZ(calc(var(--S) / 2 + 20px)); }
        .cube:hover .face.left { transform: rotateY(-90deg) translateZ(calc(var(--S) / 2 + 20px)); }
        .cube:hover .face.right { transform: rotateY(90deg) translateZ(calc(var(--S) / 2 + 20px)); }
        .cube:hover .face.top { transform: rotateX(90deg) translateZ(calc(var(--S) / 2 + 20px)); }
        .cube:hover .face.bottom { transform: rotateX(-90deg) translateZ(calc(var(--S) / 2 + 20px)); }
        
        /* Cube disappear transition */
        .cube-container {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .cube-container.hidden {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }
        
        /* Cube face styles */
        .face {
            position: absolute;
            width: var(--S);
            height: var(--S);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 32px;
            font-weight: bold;
            color: white;
            box-shadow: inset 0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        .face.front { transform: translateZ(calc(var(--S) / 2)); }
        .face.back { transform: rotateY(180deg) translateZ(calc(var(--S) / 2)); }
        .face.left { transform: rotateY(-90deg) translateZ(calc(var(--S) / 2)); }
        .face.right { transform: rotateY(90deg) translateZ(calc(var(--S) / 2)); }
        .face.top { transform: rotateX(90deg) translateZ(calc(var(--S) / 2)); }
        .face.bottom { transform: rotateX(-90deg) translateZ(calc(var(--S) / 2)); }
        
        /* Gradient colors for cube faces */
        .face.front { background: linear-gradient(135deg, #4285f4, #c2d9ff); }
        .face.back { background: linear-gradient(135deg, #e8f0fe, #4285f4); }
        .face.left { background: linear-gradient(135deg, #a1c2fa, #ffffff); }
        .face.right { background: linear-gradient(135deg, #ffffff, #a1c2fa); }
        .face.top { background: linear-gradient(135deg, #c2d9ff, #e8f0fe); }
        .face.bottom { background: linear-gradient(135deg, #e8f0fe, #c2d9ff); }
    </style>
</head>
<body>
<!-- Simple fixed header at the top of the page -->
<div id="header-wrapper" style="position: sticky; top: 0; left: 0; width: 100%; z-index: 9999; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <header id="header">
        <div class="header-content">
            <div class="logo-container" id="homeButton" style="cursor: pointer;">
                <span class="site-name">LootBox</span>
            </div>
            <div class="controls-container">
                <!-- Thumbnail size controls with expanding behavior -->
                <div class="size-controls">
                    <button class="size-btn" id="sizeSmall" title="Small thumbnails">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="size-btn" id="sizeMedium" title="Medium thumbnails">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                    </button>
                    <button class="size-btn" id="sizeLarge" title="Large thumbnails">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="2"></rect>
                        </svg>
                    </button>
                </div>
                
                <button class="admin-button" id="adminButton">
                    <span class="admin-text">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </span>
                    <span class="close-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </header>
</div>

<!-- Main content in a separate container -->
<main id="mainContent">
    <!-- 3D Cube Logo in absolute position -->
    <div class="cube-container">
        <div class="cube" id="logoCube">
            <div class="face front"></div>
            <div class="face back"></div>
            <div class="face left"></div>
            <div class="face right"></div>
            <div class="face top"></div>
            <div class="face bottom"></div>
        </div>
    </div>
    
    <div class="container">
        <div class="search-container">
            <form action="/" method="get" class="search-form" id="searchForm">
                <div class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>
                <input type="text" name="q" placeholder="search" value="{{ search_query }}" class="search-input">
                {% if search_query %}
                    <a href="/" class="clear-btn">Clear</a>
                {% endif %}
            </form>
            <div class="categories">
                {% for key, name in categories.items() %}
                <button class="category-btn {% if current_category == key %}active{% endif %}" data-category="{{ key }}">
                    {{ name }}
                </button>
                {% endfor %}
                <button class="category-btn upload-tab" id="uploadTab" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                </button>
            </div>

            <div id="message"></div>
        </div>
    
    <!-- Admin Panel -->
    <!-- Upload Popup -->
    <div class="upload-popup" id="uploadPopup">
        <div class="upload-popup-content">
            <div class="upload-popup-header">
                <h3>Upload New Animation</h3>
                <button class="close-popup" onclick="closeUploadPopup()">&times;</button>
            </div>
            <form class="upload-form" id="uploadForm">
                <!-- 1. UPLOAD SECTION FIRST -->
                <div class="form-group">
                    <label>Animation Files</label>
                    <div class="upload-area" id="uploadArea">
                        <!-- Dropzone (initial view) -->
                        <div class="dropzone" id="dropzone">
                            <div class="dropzone-content">
                                <div class="file-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <p class="drop-text">Drop files here, or <span class="browse-text">click to browse</span></p>
                                <p class="file-info">Select files with the same name but different formats (.json, .gif, .mp4)</p>
                                <input type="file" id="animationFiles" accept="application/json,.json,.gif,.mp4,.svg" multiple class="file-input">
                            </div>
                        </div>
                        
                        <!-- Preview (shows after upload) -->
                        <div class="preview-container" id="previewContainer">
                            <div class="preview-animation">
                                <lottie-player id="uploadPreview" background="transparent" speed="1" loop style="display: none;"></lottie-player>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 2. UPLOADED FILES LIST WITH PROGRESS BARS -->
                <div class="upload-files-container" id="uploadFilesContainer">
                    <!-- Files will be added here dynamically -->
                </div>
                
                <!-- 3. NAME FIELD - Auto-populated from filename but editable -->
                <div class="form-group">
                    <label for="animationName">Animation Name</label>
                    <input type="text" id="animationName" required>
                </div>
                
                <!-- 4. CATEGORY -->
                <div class="form-group">
                    <label for="animationCategory">Category</label>
                    <select id="animationCategory" required>
                        {% for key, name in categories.items() %}
                        <option value="{{ key }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 5. TAGS -->
                <div class="form-group">
                    <label for="animationTags">Tags (comma separated)</label>
                    <input type="text" id="animationTags" placeholder="animation, motion, design">
                </div>
                
                <!-- 6. SAVE BUTTON (replaced Upload with Save) -->
                <button type="submit" class="save-btn">Save Animation</button>
            </form>
            
            <!-- File item template (hidden, will be cloned via JS) -->
            <template id="file-item-template">
                <div class="file-item">
                    <div class="file-type-icon"></div>
                    <div class="file-details">
                        <div class="file-info-row">
                            <span class="file-format-badge"></span>
                            <span class="file-name"></span>
                            <button type="button" class="remove-file">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Size controls moved to header -->
    
    <!-- Delete Confirmation Modal -->
    <div class="delete-confirm-modal" id="deleteConfirmModal">
        <div class="delete-confirm-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#d93025" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px;">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            <h3 style="margin-top: 0; font-size: 20px; color: #202124; margin-bottom: 16px;">Delete Animation</h3>
            <p style="color: #5f6368; margin-bottom: 8px;">Are you sure you want to delete <strong id="deleteAnimationName" style="color: #202124;"></strong>?</p>
            <p style="color: #5f6368; font-size: 14px;">This will permanently remove the animation and all associated files (JSON, MP4, GIF, SVG).</p>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-cancel" id="cancelDeleteBtn">Cancel</button>
                <button class="delete-confirm-delete" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- SVG Export Modal -->
    <div class="modal" id="svgExportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Export Frame as SVG</h3>
                <button class="close-modal" onclick="closeSvgExportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="svg-preview-container">
                    <div class="svg-frame-preview" id="svgFramePreview"></div>
                </div>
                <div class="frame-selection">
                    <label for="frameSlider">Select Frame:</label>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="0" class="frame-slider" id="frameSlider">
                        <div class="frame-value" id="frameValue">0</div>
                    </div>
                </div>
                <div class="download-options">
                    <button class="export-btn" onclick="copySvgToClipboard()">Copy to Clipboard</button>
                    <button class="export-btn" data-format="svg" onclick="exportSvgFrame()">Export SVG</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid" id="animationGrid">
        {% for animation in animations %}
        <div class="animation-card" data-name="{{ animation.name }}" data-path="{{ animation.path }}" data-hashtags='{{ animation.hashtags|tojson|safe }}'>
            <!-- Using data attributes instead of inline onclick to avoid syntax errors -->
            <div class="preview-container">
                <lottie-player
                    src="{{ animation.path }}"
                    background="transparent"
                    speed="1"
                    loop
                ></lottie-player>
            </div>
            <div class="animation-info">
                <h3 class="animation-name" title="{{ animation.name }}">{{ animation.name }}</h3>
            </div>
        </div>
        {% endfor %}
    </div>
    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
        <div class="loading-spinner"></div>
    </div>

    <!-- Animation Details Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closePopup()"></div>
    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <div class="login-modal-header">
                <h2>Admin Login</h2>
                <button class="close-popup" onclick="closeLoginModal()">&times;</button>
            </div>
            <form class="login-form" id="loginForm">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
            </form>
        </div>
    </div>
    
    <div class="sidebar-details" id="animationPopup">
        <div class="popup-header">
            <button class="close-popup popup-close-btn" onclick="closePopup()">&times;</button>
        </div>
        <div class="popup-content">
            <div class="popup-preview" id="previewContainer">
                <div class="bg-toggle-wrap">
                    <label class="switch">
                        <input type="checkbox" id="backgroundToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <lottie-player
                    id="popupPlayer"
                    background="#f0f0f0"
                    speed="1"
                    loop
                    autoplay
                    controls
                ></lottie-player>
            </div>
            <div class="animation-details">
                <div class="detail-section">
                    <h3>Name</h3>
                    <p id="popupTitle" class="animation-name"></p>
                </div>
                <div class="detail-section">
                    <h3>Hashtags</h3>
                    <input type="text" class="hashtags-input" placeholder="Add hashtags (press Enter)" id="hashtagInput">
                    <div class="hashtags-list" id="hashtagsList"></div>
                </div>
                <div class="detail-section">
                    <h3>Download</h3>
                    <div class="download-options">
                        <button class="export-btn" data-format="json" onclick="exportAnimation('json')">JSON</button>
                        <a href="" id="mp4Link" class="export-btn" download>MP4</a>
                        <a href="" id="gifLink" class="export-btn" download>GIF</a>
                        <button class="export-btn" data-format="svg" onclick="openSvgExportModal()">SVG</button>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h3>Share</h3>
                    <div class="share-options">
                        <button class="share-btn" id="shareLinkBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                                <polyline points="16 6 12 2 8 6"></polyline>
                                <line x1="12" y1="2" x2="12" y2="15"></line>
                            </svg>
                            Copy Link
                        </button>
                        <div class="share-tooltip" id="shareTooltip">Link copied!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script>
    let currentAnimation = null;
    let currentPage = 1;
    let loading = false;
    let currentCategory = '{{ current_category }}';
    let lastScrollPosition = 0;
    let searchQuery = '{{ search_query }}';

    // Category mapping for display names
    const CATEGORIES = JSON.parse('{{ categories|tojson|safe }}');

    document.addEventListener('DOMContentLoaded', function() {
        // Setup animation card click handlers (replacing the inline onClick we removed)
        document.querySelectorAll('.animation-card').forEach(card => {
            card.addEventListener('click', function() {
                const name = this.getAttribute('data-name');
                const path = this.getAttribute('data-path');
                const hashtags = JSON.parse(this.getAttribute('data-hashtags'));
                openPopup(name, path, hashtags);
            });
        });
        
        // Interactive cube logo
        const cube = document.getElementById('logoCube');
        let rotX = 0, rotY = 0;
        let targetRotX = 0, targetRotY = 0;
        
        document.addEventListener('mousemove', function(e) {
            // Calculate rotation based on mouse position relative to window center
            const mouseX = e.clientX;
            const mouseY = e.clientY;
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // Set target rotation with dampening
            targetRotX = (mouseY - centerY) / 20;
            targetRotY = (mouseX - centerX) / 20;
        });
        
        // Smooth animation loop for the cube
        function animateCube() {
            // Smoothly interpolate current rotation toward target
            rotX += (targetRotX - rotX) * 0.05;
            rotY += (targetRotY - rotY) * 0.05;
            
            // Apply the rotation
            cube.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
            
            requestAnimationFrame(animateCube);
        }
        
        // Start the animation loop
        animateCube();
        
        // Add event listeners to hide cube when interacting with page
        // Scroll event
        window.addEventListener('scroll', hideCube);
        
        // Search input interaction
        document.querySelector('.search-input').addEventListener('focus', hideCube);
        document.querySelector('.search-input').addEventListener('input', hideCube);
        
        // Button clicks
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', hideCube);
        });
        
        // Links clicks
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', hideCube);
        });
        
        // Add mutation observer to detect container class changes
        const containerObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'class') {
                    const container = document.querySelector('.container');
                    if (container.classList.contains('active')) {
                        // Hide cube when not on home page
                        document.querySelector('.cube-container').classList.add('hidden');
                        clearTimeout(window.cubeReappearTimer);
                    }
                }
            });
        });
        
        // Start observing container class changes
        containerObserver.observe(document.querySelector('.container'), { attributes: true });
        
        // Set a timer to show the cube again after interaction
        function hideCube() {
            document.querySelector('.cube-container').classList.add('hidden');
            
            // Show cube again after 5 seconds of no interaction, but only if we're on the home screen with no popups
            clearTimeout(window.cubeReappearTimer);
            window.cubeReappearTimer = setTimeout(() => {
                // Check if any popup is active or if we're not on the home screen
                const popupActive = document.querySelector('.sidebar-overlay.active') || 
                                  document.querySelector('.upload-popup.active');
                const notOnHomeScreen = document.querySelector('.container.active') ||
                                      document.getElementById('animationGrid').style.display !== 'none';
                
                if (!popupActive && !notOnHomeScreen) {
                    document.querySelector('.cube-container').classList.remove('hidden');
                }
            }, 5000);
        }
        // Reset to homepage state
        document.querySelector('.container').classList.remove('active');
        document.getElementById('animationGrid').style.display = 'none';
        
        // No need for complex header setup, position:sticky works reliably
        const homeButton = document.getElementById('homeButton');
        
        // Setup size controls
        const sizeSmall = document.getElementById('sizeSmall');
        const sizeMedium = document.getElementById('sizeMedium');
        const sizeLarge = document.getElementById('sizeLarge');
        const grid = document.getElementById('animationGrid');
        
        // *** IMPORTANT: Force remove active state from all category buttons ***
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        // Reset current category to empty string
        currentCategory = '';
        
        // Check URL parameters for direct linking
        const urlParams = new URLSearchParams(window.location.search);
        const animationParam = urlParams.get('animation');
        const categoryParam = urlParams.get('category');
        
        if (animationParam && categoryParam) {
            // This is a shared link, open the animation directly
            handleSharedAnimation(categoryParam, animationParam);
        } else {
            // Regular page load, clear URL without refreshing
            window.history.replaceState({}, '', '/');
        }
        
        // Setup event handlers
        setupInfiniteScroll();
        setupCategoryButtons();
        setupSearch();
        setupHashtagInput();
        setupSizeControls();
        setupAdminFunctionality();
        setupDeleteConfirmation();
    });

    function initializeLottiePlayers() {
        const players = document.querySelectorAll('lottie-player:not(#popupPlayer)');
        players.forEach(initializeLottiePlayer);
    }

    function initializeLottiePlayer(player) {
        player.load(player.src).then(() => {
            player.seek('0%');
            player.stop();
        });

        player.addEventListener('mouseenter', () => player.play());
        player.addEventListener('mouseleave', () => {
            player.stop();
            player.seek('0%');
        });
    }

    function setupInfiniteScroll() {
        window.addEventListener('scroll', debounce(() => {
            if (loading) return;

            // Header is now always visible by default, no need to toggle based on scroll

            const scrollPosition = window.scrollY + window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight;

            if (scrollPosition >= documentHeight - 1000) {
                loadMoreAnimations();
            }
        }, 200));
        
        // Add home button functionality
        document.getElementById('homeButton').addEventListener('click', function() {
            // Reset to home state
            document.querySelector('.container').classList.remove('active');
            document.getElementById('animationGrid').style.display = 'none';
            document.getElementById('animationGrid').classList.remove('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Make cube reappear with a slight delay when returning to home page
            setTimeout(() => {
                document.querySelector('.cube-container').classList.remove('hidden');
            }, 800); // 800ms delay for a more natural reappearance
        });
    }

    function setupCategoryButtons() {
        document.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', () => {
                // Update active state
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                // Add active state to container
                document.querySelector('.container').classList.add('active');
                
                // Reset and prepare grid
                currentCategory = button.dataset.category;
                currentPage = 1;
                const grid = document.getElementById('animationGrid');
                grid.innerHTML = '';
                grid.style.display = 'grid';
                grid.classList.remove('active');
                
                // Update URL without refreshing
                window.history.pushState({}, '', `/${currentCategory}`);
                
                // Delay loading animations
                setTimeout(() => {
                    loadMoreAnimations();
                    grid.classList.add('active');
                }, 400);
            });
        });
    }

    function setupSearch() {
        const form = document.getElementById('searchForm');
        const input = form.querySelector('input');

        let debounceTimeout;
        input.addEventListener('input', () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                searchQuery = input.value.trim();
                currentPage = 1;
                
                // Show grid and move search bar up if there's a search query
                const container = document.querySelector('.container');
                const grid = document.getElementById('animationGrid');
                
                if (searchQuery) {
                    container.classList.add('active');
                    grid.style.display = 'grid';
                    grid.innerHTML = '';
                    currentCategory = ''; // Clear category filter
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    grid.classList.add('active'); // Ensure grid is visible
                    loadMoreAnimations();
                } else {
                    container.classList.remove('active');
                    grid.style.display = 'none';
                    grid.innerHTML = '';
                    grid.classList.remove('active');
                }
            }, 300);
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            // Handle explicit form submission
            const searchInput = form.querySelector('input');
            searchQuery = searchInput.value.trim();
            if (searchQuery) {
                currentPage = 1;
                const container = document.querySelector('.container');
                const grid = document.getElementById('animationGrid');
                
                container.classList.add('active');
                grid.style.display = 'grid';
                grid.innerHTML = '';
                currentCategory = '';
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                grid.classList.add('active');
                loadMoreAnimations();
            }
        });
    }

    function setupHashtagInput() {
        const hashtagInput = document.getElementById('hashtagInput');
        hashtagInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && this.value.trim()) {
                addHashtag(this.value.trim());
                this.value = '';
            }
        });
    }

    function openPopup(name, path, hashtags) {
        // Extract category from the path
        const pathParts = path.split('/');
        const category = pathParts[3]; // Format: /static/animations/[category]/[file]
        
        currentAnimation = { 
            name, 
            path, 
            hashtags,
            category: category
        };
        
        // Prevent background scrolling and ensure cube stays hidden
        document.body.classList.add('no-scroll');
        document.querySelector('.cube-container').classList.add('hidden');
        // Cancel any pending cube reappear timers
        clearTimeout(window.cubeReappearTimer);
        
        // Hide header when side menu is active
        document.getElementById('header-wrapper').classList.add('hidden');
        
        // Update popup content
        document.getElementById('popupTitle').textContent = name;
        const player = document.getElementById('popupPlayer');
        player.load(path);
        
        // Update download links for MP4 and GIF
        updateDownloadLinks(category, name);
        
        // Setup share button functionality
        setupShareButton();

        // Display hashtags
        const hashtagsList = document.getElementById('hashtagsList');
        hashtagsList.innerHTML = '';
        hashtags.forEach(tag => {
            const tagElement = createHashtagElement(tag);
            hashtagsList.appendChild(tagElement);
        });

        // Show sidebar and overlay
        document.getElementById('animationPopup').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
    }

    function closePopup() {
        document.getElementById('animationPopup').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        
        // Re-enable background scrolling
        document.body.classList.remove('no-scroll');
        
        // Show header again
        document.getElementById('header-wrapper').classList.remove('hidden');
        
        // Don't show cube immediately after closing popup, wait for timer
        // And only show if we're actually on the home screen
        clearTimeout(window.cubeReappearTimer);
        window.cubeReappearTimer = setTimeout(() => {
            const notOnHomeScreen = document.querySelector('.container.active') ||
                                   document.getElementById('animationGrid').style.display !== 'none';
            
            if (!notOnHomeScreen) {
                document.querySelector('.cube-container').classList.remove('hidden');
            }
        }, 800);
        document.getElementById('popupPlayer').stop();
        currentAnimation = null;
    }
    
    function setupSizeControls() {
        // Size control buttons
        const sizeSmall = document.getElementById('sizeSmall');
        const sizeMedium = document.getElementById('sizeMedium');
        const sizeLarge = document.getElementById('sizeLarge');
        const grid = document.getElementById('animationGrid');
        
        // Size control functionality
        sizeSmall.addEventListener('click', function() {
            setThumbnailSize('small');
        });
        
        sizeMedium.addEventListener('click', function() {
            setThumbnailSize('medium');
        });
        
        sizeLarge.addEventListener('click', function() {
            setThumbnailSize('large');
        });
        
        // Set default size or load from localStorage
        const savedSize = localStorage.getItem('thumbnailSize') || 'medium';
        setThumbnailSize(savedSize);
        
        function setThumbnailSize(size) {
            // Remove all size classes
            grid.classList.remove('size-small', 'size-medium', 'size-large');
            // Add the selected size class
            grid.classList.add('size-' + size);
            // Update active button
            document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('size' + size.charAt(0).toUpperCase() + size.slice(1)).classList.add('active');
            // Save preference
            localStorage.setItem('thumbnailSize', size);
        }
    }
    
    // Admin functionality
    function setupAdminFunctionality() {
        const adminButton = document.getElementById('adminButton');
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const uploadTab = document.getElementById('uploadTab');
        const uploadPopup = document.getElementById('uploadPopup');
        const uploadForm = document.getElementById('uploadForm');
        
        // Admin state
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        
        // Update UI based on admin state
        function updateAdminUI() {
            if (isAdmin) {
                adminButton.classList.add('active');
                uploadTab.style.display = 'block';
            } else {
                adminButton.classList.remove('active');
                uploadTab.style.display = 'none';
                uploadPopup.classList.remove('active');
            }
        }
        
        // Initialize admin UI
        updateAdminUI();
        
        // Admin button click
        adminButton.addEventListener('click', function() {
            console.log('Admin button clicked, current state:', isAdmin);
            if (isAdmin) {
                // Log out
                isAdmin = false;
                localStorage.removeItem('isAdmin');
                updateAdminUI();
                alert('Logged out of admin mode');
            } else {
                // Show login modal and prevent background scrolling
                loginModal.classList.add('active');
                document.body.classList.add('no-scroll');
            }
        });
        
        // Close login modal
        window.closeLoginModal = function() {
            loginModal.classList.remove('active');
            document.body.classList.remove('no-scroll');
        };
        
        // Handle login form submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Simple authentication (should be replaced with proper auth in production)
            if (username === 'admin' && password === 'admin') {
                isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                updateAdminUI();
                closeLoginModal();
            } else {
                alert('Invalid credentials');
            }
        });
        
        // Upload tab click
        uploadTab.addEventListener('click', function() {
            // Show upload popup
            uploadPopup.classList.add('active');
            // Prevent background scrolling and ensure cube stays hidden
            document.body.classList.add('no-scroll');
            document.querySelector('.cube-container').classList.add('hidden');
            // Cancel any pending cube reappear timers
            clearTimeout(window.cubeReappearTimer);
            // Hide header when upload popup is active
            document.getElementById('header-wrapper').classList.add('hidden');
            
            // Update active state
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            uploadTab.classList.add('active');
        });
        
        // Close upload popup
        window.closeUploadPopup = function() {
            uploadPopup.classList.remove('active');
            // Re-enable background scrolling
            document.body.classList.remove('no-scroll');
            // Show header again
            document.getElementById('header-wrapper').classList.remove('hidden');
            uploadTab.classList.remove('active');
        };
        
        // File upload tracking
        let uploadedFiles = [];
        const fileContainer = document.getElementById('uploadFilesContainer');
        const fileTemplate = document.getElementById('file-item-template');
        const animationNameInput = document.getElementById('animationName');
        const previewContainer = document.getElementById('previewContainer');
        const previewPlaceholder = previewContainer.querySelector('.preview-placeholder');
        const previewAnimation = previewContainer.querySelector('.preview-animation');
        const uploadPreview = document.getElementById('uploadPreview');
        
        // Handle file selection or drop
        document.getElementById('animationFiles').addEventListener('change', handleFileSelection);
        
        // Function to reset file input state
        function resetFileInput() {
            // Show dropzone again and hide preview
            dropzone.style.display = 'block';
            previewContainer.style.display = 'none';
            uploadPreview.style.display = 'none';
            
            // Reset the file input to allow selecting the same files again
            document.getElementById('animationFiles').value = '';
        }
        
        // Drag and drop functionality
        const dropzone = document.getElementById('dropzone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => {
                dropzone.classList.add('highlight');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, () => {
                dropzone.classList.remove('highlight');
            });
        });
        
        dropzone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        });
        
        function handleFileSelection(e) {
            const files = e.target.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            // Group files by base name (without extension)
            const filesByName = {};
            Array.from(files).forEach(file => {
                const nameParts = file.name.split('.');
                const extension = nameParts.pop().toLowerCase();
                const baseName = nameParts.join('.');
                
                if (!filesByName[baseName]) {
                    filesByName[baseName] = [];
                }
                filesByName[baseName].push({
                    file,
                    format: extension
                });
            });
            
            // Auto-set animation name from first file
            if (Object.keys(filesByName).length > 0 && !animationNameInput.value) {
                animationNameInput.value = Object.keys(filesByName)[0];
            }
            
            // Add each file to the UI and start upload
            Object.entries(filesByName).forEach(([baseName, fileList]) => {
                fileList.forEach(fileInfo => {
                    addFileToUI(fileInfo.file, fileInfo.format);
                });
            });
        }
        
        function addFileToUI(file, format) {
            // Clone the template
            const newFileItem = document.importNode(fileTemplate.content, true).querySelector('.file-item');
            
            // Set file info
            const fileFormatBadge = newFileItem.querySelector('.file-format-badge');
            fileFormatBadge.textContent = format.toUpperCase();
            fileFormatBadge.classList.add(`format-${format}`);
            
            newFileItem.querySelector('.file-name').textContent = file.name;
            
            // Set icon based on format
            const typeIcon = newFileItem.querySelector('.file-type-icon');
            if (format === 'json') {
                typeIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>';
            } else if (format === 'mp4') {
                typeIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>';
            } else if (format === 'gif') {
                typeIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>';
            }
            
            // Add remove button functionality
            newFileItem.querySelector('.remove-file').addEventListener('click', () => {
                removeFile(newFileItem, file);
                
                // Check if no files are left, reset to file input state
                if (fileContainer.children.length === 0) {
                    resetFileInput();
                }
            });
            
            // Add to container
            fileContainer.appendChild(newFileItem);
            
            // Start upload immediately
            uploadFile(file, newFileItem);
            
            // Track the file
            uploadedFiles.push({
                file,
                format,
                element: newFileItem
            });
            
            // If it's a JSON file, set up the preview
            if (format === 'json') {
                setupJsonPreview(file);
            }
        }
        
        function removeFile(element, file) {
            // Remove from UI
            element.remove();
            
            // Remove from tracking array
            uploadedFiles = uploadedFiles.filter(f => f.file !== file);
            
            // If we just removed the JSON file, hide the preview
            if (file.name.toLowerCase().endsWith('.json')) {
                // Check if there's another JSON file
                const hasAnotherJson = uploadedFiles.some(f => f.file.name.toLowerCase().endsWith('.json'));
                if (!hasAnotherJson) {
                    resetFileInput();
                }
            }
        }
        
        function setupJsonPreview(jsonFile) {
            // Read the JSON file for preview
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    
                    // Hide dropzone and show preview
                    dropzone.style.display = 'none';
                    previewContainer.style.display = 'flex';
                    
                    // Show, load and play the lottie animation
                    uploadPreview.style.display = 'block';
                    uploadPreview.load(jsonData);
                    uploadPreview.play();
                } catch (error) {
                    console.error('Error parsing JSON for preview:', error);
                    showMessage('Unable to preview animation. Invalid JSON format.', 'error');
                }
            };
            reader.onerror = function() {
                showMessage('Failed to read the JSON file for preview', 'error');
            };
            reader.readAsText(jsonFile);
        }

        function uploadFile(file, element) {
            // Set up progress tracking
            const progressBar = element.querySelector('.progress-bar');
            const progressContainer = element.querySelector('.progress-container');
            
            // Create a new XHR request (to track progress)
            const xhr = new XMLHttpRequest();
            
            // Create FormData
            const formData = new FormData();
            formData.append('file', file);
            formData.append('filename', file.name);  // Send the original filename
            
            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                }
            });
            
            // Handle completion
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    progressContainer.classList.add('upload-complete');
                    element.classList.add('success');
                    const response = JSON.parse(xhr.responseText);
                    
                    // Update the file object with the server-side data
                    const fileIndex = uploadedFiles.findIndex(f => f.file === file);
                    if (fileIndex !== -1) {
                        uploadedFiles[fileIndex].tempId = response.temp_id;
                        uploadedFiles[fileIndex].serverId = response.id;
                    }
                } else {
                    progressContainer.classList.add('upload-error');
                    element.classList.add('error');
                    try {
                        const response = JSON.parse(xhr.responseText);
                        showMessage('Upload error: ' + response.error, 'error');
                    } catch (e) {
                        showMessage('Upload failed', 'error');
                    }
                }
            });
            
            // Handle errors
            xhr.addEventListener('error', () => {
                progressContainer.classList.add('upload-error');
                element.classList.add('error');
                showMessage('Network error during upload', 'error');
            });
            
            // Start the upload - using the new upload-temp endpoint
            xhr.open('POST', '/api/upload-temp', true);
            xhr.send(formData);
        }
        
        // Handle form submission (saving the animation metadata)
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // If no files were uploaded, show an error
            if (uploadedFiles.length === 0) {
                showMessage('Please upload at least one file', 'error');
                return;
            }
            
            const name = document.getElementById('animationName').value;
            const category = document.getElementById('animationCategory').value;
            const tags = document.getElementById('animationTags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
            
            // Create form data with metadata and file references
            const formData = new FormData();
            formData.append('name', name);
            formData.append('category', category);
            formData.append('tags', JSON.stringify(tags));
            formData.append('fileCount', uploadedFiles.length);
            
            // Add each uploaded file's information
            uploadedFiles.forEach((fileInfo, index) => {
                formData.append(`fileFormat_${index}`, fileInfo.format);
                formData.append(`fileId_${index}`, fileInfo.tempId || '');
                formData.append(`fileName_${index}`, fileInfo.file.name);
            });
            
            // Send to server
            fetch('/api/save-animation', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Animation saved successfully!', 'success');
                    // Reset everything
                    uploadForm.reset();
                    fileContainer.innerHTML = '';
                    uploadedFiles = [];
                    
                    // Reset all UI components
                    dropzone.style.display = 'block';
                    previewContainer.style.display = 'none';
                    uploadPreview.style.display = 'none';
                    uploadPreview.stop();
                    uploadPreview.load(null);
                    document.getElementById('animationFiles').value = '';
                    
                    // Close popup
                    closeUploadPopup();
                    
                    // Refresh the page after a slight delay to show new animation
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Failed to save animation. Please try again.', 'error');
            });
        });
    }

    function createHashtagElement(tag) {
        const div = document.createElement('div');
        div.className = 'hashtag';
        div.innerHTML = `
            #${tag}
            <button onclick="removeHashtag('${tag}')">×</button>
        `;
        return div;
    }

    async function addHashtag(tag) {
        if (!currentAnimation) return;
        
        const hashtags = new Set([...currentAnimation.hashtags]);
        hashtags.add(tag);
        await updateHashtags(Array.from(hashtags));
    }

    async function removeHashtag(tag) {
        if (!currentAnimation) return;
        
        const hashtags = new Set([...currentAnimation.hashtags]);
        hashtags.delete(tag);
        await updateHashtags(Array.from(hashtags));
    }

    async function updateHashtags(hashtags) {
        try {
            const response = await fetch(`/api/hashtags/${currentAnimation.name}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hashtags })
            });

            if (response.ok) {
                currentAnimation.hashtags = hashtags;
                const hashtagsList = document.getElementById('hashtagsList');
                hashtagsList.innerHTML = '';
                hashtags.forEach(tag => {
                    const tagElement = createHashtagElement(tag);
                    hashtagsList.appendChild(tagElement);
                });
            }
        } catch (error) {
            console.error('Failed to update hashtags:', error);
        }
    }

    async function exportAnimation(format) {
        if (!currentAnimation) {
            alert('Please select an animation first');
            return;
        }
        
        // Special case for SVG - open frame extraction modal instead of downloading directly
        if (format === 'svg') {
            openSvgExportModal();
            return;
        }
        
        // Show loading indicator
        const exportBtns = document.querySelectorAll('.export-btn');
        const clickedBtn = [...exportBtns].find(btn => btn.getAttribute('data-format') === format);
        const originalText = clickedBtn ? clickedBtn.textContent : format.toUpperCase();
        
        if (clickedBtn) {
            clickedBtn.textContent = 'Downloading...';
            clickedBtn.disabled = true;
        }
        
        try {
            // For JSON format, we can handle it directly in the client
            if (format === 'json') {
                // First try the new structure with lottie subfolder
                let response = await fetch(`/static/animations/${currentAnimation.category}/lottie/${currentAnimation.name}.json`);
                
                // If not found, try the old path structure
                if (!response.ok) {
                    response = await fetch(`/static/animations/${currentAnimation.category}/${currentAnimation.name}.json`);
                }
                if (!response.ok) throw new Error('Failed to load animation');
                
                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentAnimation.name}.json`;
                a.click();
                
                window.URL.revokeObjectURL(url);
            } else {
                // For MP4 and GIF, use direct file download with iframe
                try {
                    // First check if the file exists using a HEAD request
                    let fileUrl = '';
                    if (format === 'mp4') {
                        fileUrl = `/static/animations/${currentAnimation.category}/mp4/${currentAnimation.name}.mp4`;
                    } else if (format === 'gif') {
                        fileUrl = `/static/animations/${currentAnimation.category}/gif/${currentAnimation.name}.gif`;
                    }
                    
                    // Test if the file exists
                    const headResponse = await fetch(fileUrl, { method: 'HEAD' });
                    
                    if (!headResponse.ok) {
                        throw new Error(`${format.toUpperCase()} version not available for this animation`);
                    }
                    
                    // Create a hidden iframe for download
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = fileUrl;
                    document.body.appendChild(iframe);
                    
                    // Remove iframe after load
                    setTimeout(() => {
                        document.body.removeChild(iframe);
                    }, 2000);
                } catch (error) {
                    throw new Error(error.message || `Failed to download ${format.toUpperCase()} version`);
                }
            }
        } catch (error) {
            alert(error.message || `Failed to download ${format.toUpperCase()} version`);
            console.error('Download error:', error);
        } finally {
            // Reset button state
            if (clickedBtn) {
                clickedBtn.textContent = originalText;
                clickedBtn.disabled = false;
            }
        }
    }

    // Keep track of retry attempts and loading state
    let retryCount = 0;
    const MAX_RETRIES = 3;
    let animationLoadingTimeout = null;
    
    async function loadMoreAnimations(isRetry = false) {
        // Don't allow multiple concurrent loading requests unless it's a retry
        if (loading && !isRetry) return;
        
        // Only show loading indicator on first attempt, not retries
        if (!isRetry) {
            loading = true;
            document.getElementById('loadingIndicator').style.display = 'block';
        }

        try {
            // Clear any pending retry timeouts to prevent race conditions
            if (animationLoadingTimeout) {
                clearTimeout(animationLoadingTimeout);
                animationLoadingTimeout = null;
            }
            
            const encodedQuery = encodeURIComponent(searchQuery || '');
            console.log(`Loading animations: category=${currentCategory}, query=${encodedQuery}, page=${currentPage}${isRetry ? ` (retry ${retryCount}/${MAX_RETRIES})` : ''}`);
            
            // Add a small delay for retry attempts to avoid overwhelming the server
            if (isRetry) {
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            const response = await fetch(`/api/animations?category=${currentCategory}&page=${currentPage}&q=${encodedQuery}`, {
                // Adding a cache control header to avoid cached responses
                headers: { 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Received data:', data);
            
            // Reset retry counter on success
            retryCount = 0;

            if (data.animations && data.animations.length > 0) {
                const grid = document.getElementById('animationGrid');
                // Make sure grid is visible and active
                grid.style.display = 'grid';
                document.querySelector('.container').classList.add('active');
                
                // Add new animations with a slight delay to prevent layout thrashing
                setTimeout(() => {
                    data.animations.forEach(animation => {
                        const card = createAnimationCard(animation);
                        grid.appendChild(card);
                    });
                    
                    // Initialize all new lottie players with a slight delay
                    setTimeout(() => {
                        const newCards = document.querySelectorAll('.animation-card:not(.initialized)');
                        newCards.forEach(card => {
                            card.classList.add('initialized');
                            initializeLottiePlayer(card.querySelector('lottie-player'));
                        });
                    }, 100);
                    
                    currentPage++;
                    
                    // Add active class with a slight delay to ensure transition works
                    setTimeout(() => {
                        grid.classList.add('active');
                    }, 50);
                }, 10);
            } else {
                // No results - show a more subtle message
                const message = document.getElementById('message');
                message.textContent = searchQuery ? `No results found for "${searchQuery}"` : 'No animations found';
                message.className = 'info';
                message.style.display = 'block';
                message.style.opacity = '1';
                message.style.transition = 'opacity 0.3s ease';
                
                // Fade out after delay
                setTimeout(() => {
                    message.style.opacity = '0';
                    setTimeout(() => {
                        message.style.display = 'none';
                    }, 300);
                }, 3000);
            }
        } catch (error) {
            console.error(`Error loading animations (attempt ${retryCount + 1}):`, error);
            
            // Attempt to retry loading animations if under max retries
            if (retryCount < MAX_RETRIES) {
                retryCount++;
                console.log(`Retrying animation load (${retryCount}/${MAX_RETRIES})...`);
                
                // Use exponential backoff for retries (800ms, 1600ms, 3200ms)
                const retryDelay = 800 * Math.pow(2, retryCount - 1);
                
                // Only show a subtle retry message if we've had multiple failures
                if (retryCount > 1) {
                    const message = document.getElementById('message');
                    message.textContent = `Reconnecting... (${retryCount}/${MAX_RETRIES})`;
                    message.className = 'info';
                    message.style.display = 'block';
                    message.style.opacity = '0.7';
                }
                
                // Schedule retry with backoff
                animationLoadingTimeout = setTimeout(() => {
                    loadMoreAnimations(true); // true indicates this is a retry
                }, retryDelay);
                
                return; // Exit early without clearing loading state
            } else {
                // After maximum retries, show a more detailed but less intrusive error message
                const message = document.getElementById('message');
                message.innerHTML = `<div>Unable to load content. Please check your connection.</div>`;
                message.className = 'info';
                message.style.display = 'block';
                
                // Add a refresh button inline
                const refreshButton = document.createElement('button');
                refreshButton.textContent = 'Try Again';
                refreshButton.style.margin = '8px auto 0';
                refreshButton.style.padding = '4px 12px';
                refreshButton.style.background = '#fff';
                refreshButton.style.color = '#333';
                refreshButton.style.border = 'none';
                refreshButton.style.borderRadius = '4px';
                refreshButton.style.cursor = 'pointer';
                refreshButton.style.display = 'block';
                refreshButton.onclick = () => {
                    message.style.display = 'none';
                    retryCount = 0;
                    loadMoreAnimations();
                };
                message.appendChild(refreshButton);
                
                // Clear loading state
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        } finally {
            // Only clear loading states if we're done with all retries or succeeded
            if (!animationLoadingTimeout) {
                loading = false;
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }
    }

    // Function to update download links based on animation
    function updateDownloadLinks(category, name) {
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        
        // Update MP4 link
        const mp4Link = document.getElementById('mp4Link');
        const mp4Url = `/static/animations/${category}/mp4/${name}.mp4`;
        mp4Link.href = mp4Url;
        mp4Link.download = `${name}.mp4`;
        mp4Link.classList.remove('disabled', 'admin-upload');
        
        // Check if MP4 exists
        fetch(mp4Url, { method: 'HEAD' })
            .then(response => {
                if (!response.ok) {
                    if (isAdmin) {
                        // Admin mode - transform to upload button
                        mp4Link.classList.add('admin-upload');
                        mp4Link.title = 'Upload MP4 file';
                        mp4Link.innerHTML = `MP4 <span class="upload-icon">+</span>`;
                        mp4Link.onclick = (e) => {
                            e.preventDefault();
                            openMediaUpload(category, name, 'mp4');
                        };
                    } else {
                        // Normal user mode - disabled button
                        mp4Link.classList.add('disabled');
                        mp4Link.title = 'MP4 not available';
                        mp4Link.innerHTML = 'MP4';
                        mp4Link.onclick = e => e.preventDefault();
                    }
                } else {
                    mp4Link.classList.remove('disabled', 'admin-upload');
                    mp4Link.title = 'Download MP4';
                    mp4Link.innerHTML = 'MP4';
                    mp4Link.onclick = null;
                }
            })
            .catch(() => {
                if (isAdmin) {
                    // Admin mode - transform to upload button
                    mp4Link.classList.add('admin-upload');
                    mp4Link.title = 'Upload MP4 file';
                    mp4Link.innerHTML = `MP4 <span class="upload-icon">+</span>`;
                    mp4Link.onclick = (e) => {
                        e.preventDefault();
                        openMediaUpload(category, name, 'mp4');
                    };
                } else {
                    mp4Link.classList.add('disabled');
                    mp4Link.title = 'MP4 not available';
                    mp4Link.innerHTML = 'MP4';
                    mp4Link.onclick = e => e.preventDefault();
                }
            });
        
        // Update GIF link
        const gifLink = document.getElementById('gifLink');
        const gifUrl = `/static/animations/${category}/gif/${name}.gif`;
        gifLink.href = gifUrl;
        gifLink.download = `${name}.gif`;
        gifLink.classList.remove('disabled', 'admin-upload');
        
        // Check if GIF exists
        fetch(gifUrl, { method: 'HEAD' })
            .then(response => {
                if (!response.ok) {
                    if (isAdmin) {
                        // Admin mode - transform to upload button
                        gifLink.classList.add('admin-upload');
                        gifLink.title = 'Upload GIF file';
                        gifLink.innerHTML = `GIF <span class="upload-icon">+</span>`;
                        gifLink.onclick = (e) => {
                            e.preventDefault();
                            openMediaUpload(category, name, 'gif');
                        };
                    } else {
                        // Normal user mode - disabled button
                        gifLink.classList.add('disabled');
                        gifLink.title = 'GIF not available';
                        gifLink.innerHTML = 'GIF';
                        gifLink.onclick = e => e.preventDefault();
                    }
                } else {
                    gifLink.classList.remove('disabled', 'admin-upload');
                    gifLink.title = 'Download GIF';
                    gifLink.innerHTML = 'GIF';
                    gifLink.onclick = null;
                }
            })
            .catch(() => {
                if (isAdmin) {
                    // Admin mode - transform to upload button
                    gifLink.classList.add('admin-upload');
                    gifLink.title = 'Upload GIF file';
                    gifLink.innerHTML = `GIF <span class="upload-icon">+</span>`;
                    gifLink.onclick = (e) => {
                        e.preventDefault();
                        openMediaUpload(category, name, 'gif');
                    };
                } else {
                    // Normal user mode - disabled button
                    gifLink.classList.add('disabled');
                    gifLink.title = 'GIF not available';
                    gifLink.innerHTML = 'GIF';
                    gifLink.onclick = e => e.preventDefault();
                }
            });
    }
    
    // Function to open media upload dialog
    function openMediaUpload(category, name, format) {
        // Create file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = format === 'mp4' ? 'video/mp4' : 'image/gif';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        // Handle file selection
        fileInput.onchange = async (e) => {
            if (!e.target.files.length) {
                document.body.removeChild(fileInput);
                return;
            }
            
            const file = e.target.files[0];
            uploadMediaFile(category, name, format, file);
            document.body.removeChild(fileInput);
        };
        
        // Open file selector
        fileInput.click();
    }
    
    // Function to upload media file
    async function uploadMediaFile(category, name, format, file) {
        // Show loading state
        const mediaLink = format === 'mp4' ? document.getElementById('mp4Link') : document.getElementById('gifLink');
        const originalContent = mediaLink.innerHTML;
        mediaLink.innerHTML = `<span class="spinner"></span> Uploading...`;
        mediaLink.onclick = e => e.preventDefault();
        
        try {
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            formData.append('category', category);
            formData.append('format', format);
            
            // Send to server
            const response = await fetch('/api/upload-media', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update button to show success
                mediaLink.classList.remove('admin-upload', 'disabled');
                mediaLink.innerHTML = format.toUpperCase();
                mediaLink.title = `Download ${format.toUpperCase()}`;
                mediaLink.href = result.url;
                mediaLink.onclick = null;
                
                // Show success message
                showMessage(`${format.toUpperCase()} file uploaded successfully!`, 'success');
            } else {
                throw new Error(result.error || 'Upload failed');
            }
        } catch (error) {
            // Restore button and show error
            mediaLink.innerHTML = originalContent;
            mediaLink.classList.add('admin-upload');
            mediaLink.onclick = (e) => {
                e.preventDefault();
                openMediaUpload(category, name, format);
            };
            
            showMessage(error.message || 'Upload failed', 'error');
        }
    }
    
    // Function to show messages
    function showMessage(text, type = 'info') {
        const message = document.getElementById('message');
        message.textContent = text;
        message.className = '';
        message.classList.add(type);
        message.style.display = 'block';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
            message.style.display = 'none';
        }, 3000);
    }
    
    function createAnimationCard(animation) {
        const div = document.createElement('div');
        div.className = 'animation-card';
        
        // Only attach click handler to the main part, not any admin controls
        const openPopupHandler = () => openPopup(animation.name, animation.path, animation.hashtags);
        
        // Show category tag if we're in global search mode
        const categoryTag = !currentCategory ? 
            `<div class="category-tag">${CATEGORIES[animation.category]}</div>` : '';
            
        // Add delete button if in admin mode
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        const adminControls = isAdmin ? 
            `<div class="admin-controls">
                <button class="delete-animation-btn" title="Delete animation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </button>
            </div>` : '';
            
        div.innerHTML = `
            ${categoryTag}
            ${adminControls}
            <div class="preview-container">
                <lottie-player
                    src="${animation.path}"
                    background="transparent"
                    speed="1"
                    loop
                ></lottie-player>
            </div>
            <div class="animation-info">
                <h3 class="animation-name" title="${animation.name}">${animation.name}</h3>
            </div>
        `;
        
        // Add click event to the preview container and animation info
        div.querySelector('.preview-container').addEventListener('click', openPopupHandler);
        div.querySelector('.animation-info').addEventListener('click', openPopupHandler);
        
        // Add click event for delete button if in admin mode
        if (isAdmin) {
            const deleteBtn = div.querySelector('.delete-animation-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent opening the popup
                confirmDeleteAnimation(animation);
            });
        }
        
        return div;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Function to generate a shareable link for an animation
    function generateShareableLink(animation) {
        if (!animation || !animation.category || !animation.name) {
            return window.location.origin;
        }
        
        // Create URL with proper encoding to handle spaces and special characters
        const baseUrl = window.location.origin;
        const category = encodeURIComponent(animation.category);
        const name = encodeURIComponent(animation.name);
        
        return `${baseUrl}/?category=${category}&animation=${name}`;
    }
    
    // SVG export functionality
    let svgExportPlayer = null;
    let svgTotalFrames = 0;
    let currentFrame = 0;
    
    function openSvgExportModal() {
        if (!currentAnimation) {
            alert('Please select an animation first');
            return;
        }
        
        // Show the modal and prevent background scrolling
        document.getElementById('svgExportModal').classList.add('active');
        document.body.classList.add('no-scroll');
        
        // Create a new lottie player for frame export
        const svgPreviewContainer = document.getElementById('svgFramePreview');
        svgPreviewContainer.innerHTML = '';
        
        // Create a new container for our SVG rendering
        const renderContainer = document.createElement('div');
        renderContainer.id = 'renderContainer';
        renderContainer.style.width = '100%';
        renderContainer.style.height = '100%';
        svgPreviewContainer.appendChild(renderContainer);
        
        // Load the animation directly using lottie-web
        fetch(currentAnimation.path)
            .then(response => response.json())
            .then(animationData => {
                // Initialize lottie with SVG renderer
                svgExportPlayer = lottie.loadAnimation({
                    container: renderContainer,
                    renderer: 'svg',
                    loop: false,
                    autoplay: false,
                    animationData: animationData
                });
                
                // Store animation data for direct frame rendering
                const animation = svgExportPlayer;
                
                // Get total frames
                svgTotalFrames = Math.floor(animation.totalFrames);
                
                // Update slider max value
                const frameSlider = document.getElementById('frameSlider');
                frameSlider.max = svgTotalFrames - 1;
                frameSlider.value = 0;
                document.getElementById('frameValue').textContent = '0';
                
                // Go to first frame
                animation.goToAndStop(0, true);
                currentFrame = 0;
                
                // Add event listener to slider
                frameSlider.addEventListener('input', function() {
                    currentFrame = parseInt(this.value);
                    document.getElementById('frameValue').textContent = currentFrame;
                    animation.goToAndStop(currentFrame, true);
                });
            })
            .catch(error => {
                console.error('Error loading animation:', error);
                alert('Error loading animation. Please try again.');
                closeSvgExportModal();
            });
    }
    
    function closeSvgExportModal() {
        document.getElementById('svgExportModal').classList.remove('active');
        document.body.classList.remove('no-scroll');
        
        // Reset reference
        svgExportPlayer = null;
        
        // Clear the container
        const svgPreviewContainer = document.getElementById('svgFramePreview');
        if (svgPreviewContainer) {
            svgPreviewContainer.innerHTML = '';
        }
    }
    
    // Helper function to get the prepared SVG string
    function getPrepareSvgString() {
        if (!svgExportPlayer) {
            alert('No preview available');
            return null;
        }
        
        try {
            // Get the SVG element directly from the render container
            const svgElement = document.getElementById('renderContainer').querySelector('svg');
            if (!svgElement) {
                alert('No SVG element found. Please try again.');
                return null;
            }
            
            // Clone the SVG to avoid modifying the original
            const svgClone = svgElement.cloneNode(true);
            
            // Add the xmlns attribute required for standalone SVGs
            svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            svgClone.setAttribute('width', '100%');
            svgClone.setAttribute('height', '100%');
            svgClone.setAttribute('viewBox', svgElement.getAttribute('viewBox') || '0 0 512 512');
            
            // Clean up any script tags
            const scripts = svgClone.querySelectorAll('script');
            scripts.forEach(script => script.remove());
            
            // Convert to string
            return new XMLSerializer().serializeToString(svgClone);
        } catch (error) {
            console.error('Error preparing SVG:', error);
            alert('Error preparing SVG: ' + error.message);
            return null;
        }
    }
    
    function copySvgToClipboard() {
        const svgString = getPrepareSvgString();
        if (!svgString) return;
        
        try {
            // First attempt: Modern clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(svgString)
                    .then(() => showSvgSuccess('copied to clipboard'))
                    .catch(err => {
                        console.warn('Clipboard API failed, trying fallback:', err);
                        // Fallback for public URLs: Create a temporary textarea
                        copyWithFallback(svgString);
                    });
            } else {
                // Fallback for browsers without clipboard API
                copyWithFallback(svgString);
            }
        } catch (error) {
            console.error('Error copying SVG:', error);
            
            // Show error with alternative option
            const message = document.getElementById('message');
            message.innerHTML = `<div>Unable to copy SVG directly. <button id="svgDownloadBtn" class="inline-btn">Download instead</button></div>`;
            message.className = 'warning';
            message.style.display = 'block';
            
            // Add event listener to the download button
            document.getElementById('svgDownloadBtn').addEventListener('click', exportSvgFrame);
            
            setTimeout(() => message.style.display = 'none', 5000);
        }
    }
    
    function copyWithFallback(text) {
        // Create temporary textarea element
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';  // Prevent scrolling to bottom
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        
        try {
            // Execute copy command
            const successful = document.execCommand('copy');
            if (successful) {
                showSvgSuccess('copied to clipboard');
            } else {
                throw new Error('Copy command failed');
            }
        } catch (err) {
            console.error('Fallback copy failed:', err);
            // Offer download as alternative
            const message = document.getElementById('message');
            message.innerHTML = `<div>Clipboard access denied. <button id="svgDownloadBtn" class="inline-btn">Download instead</button></div>`;
            message.className = 'warning';
            message.style.display = 'block';
            
            // Add event listener to the download button
            document.getElementById('svgDownloadBtn').addEventListener('click', exportSvgFrame);
        } finally {
            // Clean up
            document.body.removeChild(textarea);
        }
    }
    
    function showSvgSuccess(action) {
        // Show success message
        const message = document.getElementById('message');
        message.textContent = `SVG ${action}: Frame ${currentFrame}`;
        message.className = 'success';
        message.style.display = 'block';
        setTimeout(() => message.style.display = 'none', 3000);
    }
    
    function exportSvgFrame() {
        const svgString = getPrepareSvgString();
        if (!svgString) return;
        
        try {
            // Create a Blob from the SVG string
            const blob = new Blob([svgString], {type: 'image/svg+xml'});
            
            // Create a download link and trigger download
            const name = currentAnimation.name || 'animation';
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}_frame_${currentFrame}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message using the shared function
            showSvgSuccess('exported');
            
            // Close the modal
            closeSvgExportModal();
        } catch (error) {
            console.error('Error exporting SVG:', error);
            alert('Error exporting SVG: ' + error.message);
        }
    }
    
    // Handle direct animation links (from shared URLs)
    function handleSharedAnimation(category, animationName) {
        // Decode URI components to handle spaces and special characters
        const decodedCategory = decodeURIComponent(category);
        const decodedName = decodeURIComponent(animationName);
        
        // Set current category and update UI
        currentCategory = decodedCategory;
        document.querySelectorAll('.category-btn').forEach(btn => {
            if (btn.dataset.category === decodedCategory) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Make sure grid is visible
        document.querySelector('.container').classList.add('active');
        document.getElementById('animationGrid').style.display = 'grid';
        
        // Load animations for this category
        currentPage = 1; // Reset page number
        document.getElementById('animationGrid').innerHTML = ''; // Clear existing animations
        
        loadMoreAnimations();
        
        // Find the animation by name - support both folder structures
        const animationPath = `/static/animations/${decodedCategory}/lottie/${decodedName}.json`;
        
        // Try to load the animation directly
        setTimeout(() => {
            // Delay slightly to allow animations to load
            // Find the animation in the loaded grid
            let found = false;
            document.querySelectorAll('.animation-card .animation-name').forEach(nameElement => {
                if (nameElement.textContent === decodedName) {
                    // Trigger click on this animation's card
                    nameElement.closest('.animation-card').click();
                    found = true;
                }
            });
            
            if (!found) {
                // Just open with the path directly
                openPopup(decodedName, animationPath, []);
            }
        }, 1000);
    }
    
    // Setup the share button event listener
    function setupShareButton() {
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const shareTooltip = document.getElementById('shareTooltip');
        
        if (shareLinkBtn) {
            // Remove any existing event listeners by cloning and replacing
            const newBtn = shareLinkBtn.cloneNode(true);
            shareLinkBtn.parentNode.replaceChild(newBtn, shareLinkBtn);
            
            newBtn.addEventListener('click', function() {
                // Generate a shareable link for the current animation
                const shareableLink = generateShareableLink(currentAnimation);
                
                // Copy link to clipboard
                navigator.clipboard.writeText(shareableLink).then(() => {
                    // Show tooltip
                    shareTooltip.classList.add('visible');
                    
                    // Hide tooltip after 2 seconds
                    setTimeout(() => {
                        shareTooltip.classList.remove('visible');
                    }, 2000);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy link to clipboard');
                });
            });
        }
        
        // Setup background toggle
        const backgroundToggle = document.getElementById('backgroundToggle');
        const previewContainer = document.getElementById('previewContainer');
        const lottiePlayer = document.getElementById('popupPlayer');
        
        if (backgroundToggle && previewContainer && lottiePlayer) {
            backgroundToggle.addEventListener('change', function() {
                if (this.checked) {
                    previewContainer.classList.add('dark-mode');
                    // Change lottie player background to dark
                    lottiePlayer.setAttribute('background', '#202124');
                } else {
                    previewContainer.classList.remove('dark-mode');
                    // Change lottie player background to light
                    lottiePlayer.setAttribute('background', '#f0f0f0');
                }
            });
            
            // Initialize with the correct background
            lottiePlayer.setAttribute('background', '#f0f0f0');
        }
    }
    
    // Animation delete functionality
    let animationToDelete = null;
    
    function setupDeleteConfirmation() {
        // Set up event listeners for the delete confirmation modal
        document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
            document.getElementById('deleteConfirmModal').classList.remove('active');
            document.body.classList.remove('no-scroll');
            animationToDelete = null;
        });
        
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            deleteAnimation();
        });
    }
    
    function confirmDeleteAnimation(animation) {
        // Store the animation to delete
        animationToDelete = animation;
        
        // Update the modal with animation details
        document.getElementById('deleteAnimationName').textContent = animation.name;
        
        // Show the modal and prevent background scrolling
        document.getElementById('deleteConfirmModal').classList.add('active');
        document.body.classList.add('no-scroll');
    }
    
    function deleteAnimation() {
        if (!animationToDelete) return;
        
        // Show loading message
        const message = document.getElementById('message');
        message.textContent = 'Deleting animation...';
        message.className = 'info';
        message.style.display = 'block';
        
        // Send delete request to server
        fetch(`/api/delete-animation`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: animationToDelete.name,
                category: animationToDelete.category
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                message.textContent = 'Animation deleted successfully';
                message.className = 'success';
                
                // Remove the animation card from the grid
                const cards = document.querySelectorAll('.animation-card');
                cards.forEach(card => {
                    const nameElement = card.querySelector('.animation-name');
                    if (nameElement && nameElement.textContent === animationToDelete.name) {
                        card.remove();
                    }
                });
                
                // Close the popup if it's open
                if (currentAnimation && currentAnimation.name === animationToDelete.name) {
                    closePopup();
                }
            } else {
                message.textContent = data.error || 'Failed to delete animation';
                message.className = 'error';
            }
        })
        .catch(error => {
            console.error('Error deleting animation:', error);
            message.textContent = 'Error deleting animation';
            message.className = 'error';
        })
        .finally(() => {
            // Hide message after a delay
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
            
            // Reset animation to delete
            animationToDelete = null;
            
            // Close the modal
            document.getElementById('deleteConfirmModal').classList.remove('active');
            document.body.classList.remove('no-scroll');
        });
    }
    </script>
</main>
</body>
</html>
